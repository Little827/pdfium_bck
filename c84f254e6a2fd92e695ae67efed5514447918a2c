{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "3388f5a2_6b31127a",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 5045
      },
      "writtenOn": "2023-02-24T00:08:30Z",
      "side": 1,
      "message": "Would it make sense to map 1 to `kDoNothing`, and fail for all other values?",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "54f3b68c_73b57b82",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 5045
      },
      "writtenOn": "2023-02-24T00:08:53Z",
      "side": 1,
      "message": "e.g. What if the components count is 5 or 99?",
      "parentUuid": "3388f5a2_6b31127a",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8dd3b6da_0af2a76c",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7620
      },
      "writtenOn": "2023-02-24T23:11:51Z",
      "side": 1,
      "message": "If there is not colorspaces specified in the PDF, PDF should just support baseline color spaces + CMYK.\n\nI tested component number of 2,5 and 257 with the PDFs in https://bugs.chromium.org/p/pdfium/issues/detail?id\u003d1747#c7 without specifying color spaces in the PDFs, and Acrobat reported errors and didn\u0027t render those images.",
      "parentUuid": "54f3b68c_73b57b82",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "aef455ad_4e3cdff8",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7613
      },
      "writtenOn": "2023-02-28T18:45:55Z",
      "side": 1,
      "message": "I\u0027d feel more comfortable with this change if we actually looked at the JPEG 2000 spec and determined what the baseline color spaces are. That requires buying a copy of the JPEG 2000 spec, though.",
      "parentUuid": "8dd3b6da_0af2a76c",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d6ce8732_6efbe73c",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7613
      },
      "writtenOn": "2023-02-28T21:10:39Z",
      "side": 1,
      "message": "I think a potential way forward here would be to add a function along the lines of, \"has baseline color space,\" then change the definition if we ever get a bug report about it.",
      "parentUuid": "aef455ad_4e3cdff8",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4a3de1c9_2dadddd0",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 5045
      },
      "writtenOn": "2023-03-01T02:46:47Z",
      "side": 1,
      "message": "Keep in mind PDFium is not dealing with JPEG 2000 images directly. Instead, it\u0027s dealing with OpenJPEG.\n\nhttps://citeseerx.ist.psu.edu/document?repid\u003drep1\u0026type\u003dpdf\u0026doi\u003dcefcdfe7e3a12195b9488574355185da6bc99635 has a diagram showing the different color spaces, and the PDF spec talks about some of them as \"enumerated colour space NN\". The code here does not deal with that directly, whereas OpenJPEG does via struct opj_jp2\u0027s enumcs member. Looking at OpenJPEG code, it supports many, but not all the color spaces list in that doc. So the level of support in PDFium will be limited by that.",
      "parentUuid": "d6ce8732_6efbe73c",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9e3f9476_40faf4fd",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7620
      },
      "writtenOn": "2023-03-01T06:48:18Z",
      "side": 1,
      "message": "From the diagram on page 11, the following color levels are in the blue circle:\ne-sRGB, sRGB, grey-sRGB, sRGB-YCC, Erimm-RGB.\nThese are 3-channel color levels (each channel might contain different number of bits, eg Erimm-RGB.).",
      "parentUuid": "4a3de1c9_2dadddd0",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "18931590_96b3e600",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7613
      },
      "writtenOn": "2023-03-01T18:06:43Z",
      "side": 1,
      "message": "The PDF spec requires JPX baseline + CMYK (- CIEJab?); perhaps we can assume baseline is the blue circle, although the diagram says JP2, not JPX. Is grey-sRGB a single component space?",
      "parentUuid": "9e3f9476_40faf4fd",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cf9c1423_6ddc445a",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7620
      },
      "writtenOn": "2023-03-07T00:34:57Z",
      "side": 1,
      "message": "I assume the baseline for JPEG2000 is the blue circle. \n\nLei mentioned that JPX is an extension of the original JPEG2000 (JP2), and the adobe documentation clearly states that \"Consumer applications must support the\nJPX baseline set of enumerated color spaces\". So here are some more detailed findings:\n\nThe baseline colors for JPEG2000 are different types of sRGB and gray scale. (color channel are either 1 or 3, including sRGB-YCC, which has 3 channels)\n\nFor baseline of JPX, I found some answers online (not reliable) that says the baseline colorspaces are sRGB, Adobe RGB(1998), ProPhotoRGB.\n\nI assume we should move forward with the colors all types of RGBs + CYMK.\n\nhttps://www.prepressure.com/pdf/basics/color has the entire list of color spaces to be supported in PDF. \"DeviceN\" is what we are looking at. When \"DeviceN\" is customized number but the color space is not included in the PDF or mentioned in JPEG2000 documentation (JP2+JPX), I think we should fall back on DeviceGray, DeviceRGB and DeviceCMYK as the PDF ref book stated \"If no supported color space is found, the color space used should be DeviceGray, DeviceRGB, or DeviceCMYK, depending on the number of color channels in the JPEG2000 data\".",
      "parentUuid": "18931590_96b3e600",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e3f880e5_512e8fd3",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7613
      },
      "writtenOn": "2023-03-07T00:41:07Z",
      "side": 1,
      "message": "I\u0027m OK with this course of action. Note, however, that the PDF spec guidance to use DeviceGray, DeviceRGB, or DeviceCMYK only applies when the reader doesn\u0027t support the color space specified in the JPEG 2000 file. That said, we can assume for now that we don\u0027t support other color spaces, like CIELab or ICC profiles. We may need to revisit this in the future to fix color rendering.",
      "parentUuid": "cf9c1423_6ddc445a",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "26bd032a_2bcc9ac7",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7620
      },
      "writtenOn": "2023-03-07T00:53:22Z",
      "side": 1,
      "message": "Understood. \nThis change has nothing to do with falling back on device specific color spaces.\n\nIn this case, we are simply checking if the channel number match any of the baseline colorspaces of JPX or CYMK. If it doesn\u0027t match, then we do not support it.",
      "parentUuid": "e3f880e5_512e8fd3",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0f0b1b34_091f2a30",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7613
      },
      "writtenOn": "2023-03-07T01:08:34Z",
      "side": 1,
      "message": "Will the proposed change handle opacity channels correctly?",
      "parentUuid": "26bd032a_2bcc9ac7",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7821e801_a240afad",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7620
      },
      "writtenOn": "2023-03-07T02:12:12Z",
      "side": 1,
      "message": "I am not sure I understood your question correctly. Did you mean to ask if 1,3 and 4 are the numbers that already include the opacity channel?\n\nThe channel number 1,3 and 4 do not include the opacity channel, because colorspace sRGB and CMYK do not contain alpha channel. If we want to apply transparency to the image, I think GraphicState is where it should be applied.\n\nIf I misinterpret the question, could you give me an example to help me capture the question?",
      "parentUuid": "0f0b1b34_091f2a30",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "885dbb86_96785e3d",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7613
      },
      "writtenOn": "2023-03-07T03:48:52Z",
      "side": 1,
      "message": "Any JPEG 2000 can include one or more opacity channels. (This is the purpose of /SMaskInData, for example.) You can have gray + opacity, RGB + opacity, CMYK + opacity, etc.",
      "parentUuid": "7821e801_a240afad",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cbc1b543_ccd96ae7",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7620
      },
      "writtenOn": "2023-03-07T03:57:26Z",
      "side": 1,
      "message": "I will check if the component count include the extra opacity channels using the test files attached in pdfium:1747 and reply here.",
      "parentUuid": "885dbb86_96785e3d",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d3a478fe_44137321",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7613
      },
      "writtenOn": "2023-03-07T16:10:54Z",
      "side": 1,
      "message": "s/component count/channel count/, but thanks for looking into it!",
      "parentUuid": "cbc1b543_ccd96ae7",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c5d729eb_f0ac03d1",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7620
      },
      "writtenOn": "2023-03-07T22:01:27Z",
      "side": 1,
      "message": "I couldn\u0027t directly count channel through any apps, but I can look at the colorspace type:\nFor p1_07_c_2.j2k (used in com_2.pdf), colorspace type is grey-sRGB (1 color channel) and the component number is 2.\nFor issue414.jp2 (used in com_5.pdf), the colorspace type is sRGB (3 color channels) and the component number is 5.\nFor issue211.jp2 (used in comp_211.pdf), the colorspace type grey-sRGB (1 color channel) and the component number is 2.\nFor p0_13.j2k, I couldn\u0027t find out what\u0027s the colorspace type as it was not readable by my local applications. Its component number is 257.\n\nTherefore component number is usually larger than color channel and I assume opacity is handled through the extra components.\n\nIn this case, when component number is 2, I think the grey-sRGB color space should be handled. There might be other reasons why Acrobat reports errors on those PDFs.",
      "parentUuid": "d3a478fe_44137321",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2de15c1f_eb94ea49",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7613
      },
      "writtenOn": "2023-03-07T22:05:59Z",
      "side": 1,
      "message": "The \"cmap\" table allows an arbitrary relationship between components and channels; there\u0027s no point in looking at components. For example, a JPEG 2000 could have 200 components, and only use 3 of them. (That\u0027s probably the case of the p0_13.j2k.)\n\nLet\u0027s just look at the number of color channels, or if not available, the color space type. (What does the OpenJPEG API provide?)",
      "parentUuid": "c5d729eb_f0ac03d1",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1f7a238b_ef655d3f",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7613
      },
      "writtenOn": "2023-03-07T22:07:41Z",
      "side": 1,
      "message": "(It\u0027s also possible to have a single component used for multiple channels, so you could have a file with 1 component and 4 color channels, for example.)",
      "parentUuid": "2de15c1f_eb94ea49",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "95426301_e4968d06",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7620
      },
      "writtenOn": "2023-03-09T00:28:48Z",
      "side": 1,
      "message": "Some more findings:\n\n(1) Discrepancies between other PDF viewers and Acrobat: \nI tested all the JPX PDFs in our testing/resources directory, and it seems like as long as the PDF is missing /ColorSpace or /BitPerComponent entry, Acrobat will report error. (e.g: pixel test lzw1.in, acrobat reports error when rendering this test. But after I manually add the /ColorSpace and /BitsPerComponent entries, the Acrobat result matches the PDFium rendering result.) Under such circumstances, sometimes mac Preview, Okular and PDFium will utilize existing info from the image stream to try to render the image as best as they can, which caused the discrepancies that sometimes a jp2 or jpx images are rendered in a various PDF viewers and not rendered in Acrobat.\n\n(2) We can definitely add the handling to use the color space from the image stream when color space is not directly available in PDF image object entries. This does not change PDFium\u0027s current behavior regarding pixel test bug_1258634.in.\n\nIn conclusion, we can add extra handling to read the color space type from the image stream. And the PDFium behavior will basically remain the same for our existing tests. WDYT of this approach?",
      "parentUuid": "1f7a238b_ef655d3f",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a32016ca_13204dae",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7613
      },
      "writtenOn": "2023-03-09T19:00:38Z",
      "side": 1,
      "message": "I think your plan sounds fine in theory, but the details are important. Let\u0027s cover the details in code review, though.\n\nCan we add tests for all the different cases you\u0027ve looked at? In particular, I\u0027m thinking:\n\n1. JPEG 2000 color space: gray, RGB, CMYK, with or without a matching /ColorSpace\n2. JPEG 2000 opacity: absent or present, with or without /SMaskInData\n3. /BitsPerComponent: absent or present",
      "parentUuid": "95426301_e4968d06",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5e524e28_36054a2f",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7613
      },
      "writtenOn": "2023-03-11T02:23:45Z",
      "side": 1,
      "message": "I\u0027m adding tests in these changes:\nhttps://pdfium-review.googlesource.com/c/pdfium/+/104710 (gray, RGB, CMYK, with optional alpha)\nhttps://pdfium-review.googlesource.com/c/pdfium/+/104711 (omits /BitsPerComponent or /ColorSpace)\n\nAdobe Acrobat Reader can handle all the test cases correctly.",
      "parentUuid": "a32016ca_13204dae",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fc547689_4a5075d0",
        "filename": "core/fpdfapi/page/cpdf_dib.cpp",
        "patchSetId": 3
      },
      "lineNbr": 144,
      "author": {
        "id": 7620
      },
      "writtenOn": "2023-03-28T23:35:46Z",
      "side": 1,
      "message": "Acknowledged",
      "parentUuid": "5e524e28_36054a2f",
      "revId": "c84f254e6a2fd92e695ae67efed5514447918a2c",
      "serverId": "fca2d64a-0420-3532-b200-12848c95a47b"
    }
  ]
}